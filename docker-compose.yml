services:
  validator:
    image: ${DOCKER_IMAGE:-masaengineering/masa-bittensor:latest}
    deploy:
      replicas: ${VALIDATOR_COUNT:-0}
      restart_policy:
        condition: none
    volumes:
      - ~/.bittensor/wallets:/root/.bittensor/wallets
      - ~/.bt-masa:/root/.bt-masa
      - ./startup:/app/startup
      - ./masa:/app/masa
      - ./neurons:/app/neurons
      - ./pyproject.toml:/app/pyproject.toml
      - ./config.json:/app/config.json
    user: root
    environment:
      - BT_LOGGING_LOGGING_DIR=/root/.bt-masa
      - COLDKEY_MNEMONIC=${COLDKEY_MNEMONIC}
      - WALLET_NAME=${WALLET_NAME:-default}
      - REPLICA_NUM={{.Task.Slot}}
      - NETWORK=${NETWORK}
      - DEVICE=cpu
      - VALIDATOR_PORT=8091
      - VALIDATOR_METRICS_PORT=9100
      - ROLE=validator
      - PYTHONUNBUFFERED=1
      - LOGGING_DEBUG=${LOGGING_DEBUG:-false}
      - SERVICE_NAME=validator
    ports:
      - "8091-8100:8091"
      - "9100-9109:9100"
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "8091"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  miner:
    image: ${DOCKER_IMAGE:-masaengineering/masa-bittensor:latest}
    deploy:
      replicas: ${MINER_COUNT:-1}
      restart_policy:
        condition: none
    volumes:
      - ~/.bittensor/wallets:/root/.bittensor/wallets
      - ~/.bt-masa:/root/.bt-masa
      - ./startup:/app/startup
      - ./masa:/app/masa
      - ./neurons:/app/neurons
      - ./pyproject.toml:/app/pyproject.toml
    user: root
    environment:
      - BT_LOGGING_LOGGING_DIR=/root/.bt-masa
      - WALLET_NAME=${WALLET_NAME:-default}
      - NETWORK=${NETWORK}
      - DEVICE=cpu
      - MINER_PORT=8155
      - MINER_METRICS_PORT=9164
      - ROLE=miner
      - PYTHONUNBUFFERED=1
      - LOGGING_DEBUG=${LOGGING_DEBUG:-false}
      - SERVICE_NAME=miner
      - REPLICA_NUM={{.Task.Slot}}
    ports:
      - "8155-8165:8155"
      - "9164-9174:9164"
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "8155"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  subnet_wallets:
  prometheus_data:
  grafana_data:
  portainer_data:
